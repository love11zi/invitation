define(function(require,e,t){function i(){function e(){size=50,pFontName="Lucida Sans Unicode",s.font=size+"pt "+pFontName,r1.alphatop<1?r1.alphatop+=.01:r1.alphatop=1,s.globalAlpha=r1.alphatop,s.textAlign="center",1===r1.alphatop&&(r1.velY*=.999,r1.velY+=.3,r1.x+=r1.velX,r1.y+=r1.velY),r1.y+r1.height>d&&(r1.anglespin=0,r1.y=d-r1.height,r1.velY*=-.8,r1.velX*=.9),s.globalAlpha=1;for(var e=0;e<h.length;e++)h[e].draw()}function t(){s.clearRect(0,0,o,d),e(),requestAnimationFrame(t)}function i(e,t){return e+Math.random()*(t-e)}function n(e){return e*(Math.PI/180)}for(var a=document.getElementById("slide-canvas"),s=a.getContext("2d"),o=a.width=window.innerWidth,d=a.height=window.innerHeight,h=[],r=["#f44336","#e91e63","#9c27b0","#673ab7","#3f51b5","#2196f3","#03a9f4","#00bcd4","#009688","#4CAF50","#8BC34A","#CDDC39","#FFEB3B","#FFC107","#FF9800","#FF5722","#795548"],l=0;300>l;l++)h.push({x:o/2,y:d/2,boxW:i(5,20),boxH:i(5,20),size:i(2,8),spikeran:i(3,5),velX:i(-8,8),velY:i(-50,-10),angle:n(i(0,360)),color:r[Math.floor(Math.random()*r.length)],anglespin:i(-.2,.2),draw:function(){s.save(),s.translate(this.x,this.y),s.rotate(this.angle),s.fillStyle=this.color,s.beginPath(),s.fillRect(this.boxW/2*-1,this.boxH/2*-1,this.boxW,this.boxH),s.fill(),s.closePath(),s.restore(),this.angle+=this.anglespin,this.velY*=.999,this.velY+=.3,this.x+=this.velX,this.y+=this.velY,this.y<0&&(this.velY*=-.2,this.velX*=.9),this.y>d&&(this.anglespin=0,this.y=d,this.velY*=-.2,this.velX*=.9),(this.x>o||this.x<0)&&(this.velX*=-.5)}});r1={x:o/2-150,y:d/2-150,width:300,height:300,velX:0,velY:-10,alphatop:0},t()}var n,a=require("zepto"),s=require("hammer");!function(){n={init:function(){n.Drawing.init(".canvas"),document.getElementById("canvas-page").classList.add("body--ready"),-1==location.hash.indexOf("address")?n.UI.simulate("our|love|will|go|on|and|on|../img/heart.png"):n.UI.simulate("2016|03|26|welcome|to|our|wedding|../img/heart.png"),n.Drawing.loop(function(){n.Shape.render()}),setTimeout(function(){document.getElementById("canvas-bottom-txt").className="bottom-txt"},23e3),setTimeout(function(){-1==location.hash.indexOf("address")?document.getElementById("canvas-bottom-p").className="flipInX animated":document.getElementById("canvas-bottom-p-address").className="flipInX animated"},24e3),setTimeout(function(){document.getElementById("canvas-bottom-em").className="lightSpeedIn animated"},25e3)}},n.Drawing=function(){var e,t,i;return requestFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)},{init:function(i){e=document.querySelector(i),t=e.getContext("2d"),this.adjustCanvas(),window.addEventListener("resize",function(e){n.Drawing.adjustCanvas()})},loop:function(e){i=i?i:e,this.clearFrame(),i(),requestFrame.call(window,this.loop.bind(this))},adjustCanvas:function(){e.width=window.innerWidth,e.height=window.innerHeight},clearFrame:function(){t.clearRect(0,0,e.width,e.height)},getArea:function(){return{w:e.width,h:e.height}},drawCircle:function(e,i){t.fillStyle=i.render(),t.beginPath(),t.arc(e.x,e.y,e.z,0,2*Math.PI,!0),t.closePath(),t.fill()}}}(),n.UI=function(){function e(e){var t=e.getHours(),i=e.getMinutes(),i=10>i?"0"+i:i;return t+":"+i}function t(e){return e&&e.split(" ")[1]}function i(e){return e=e&&e.split(" ")[0],e&&e[0]===m&&e.substring(1)}function a(e,t,i,n){clearInterval(h),r=n?i:1,e(r),(!i||!n&&i>r||n&&r>0)&&(h=setInterval(function(){r=n?r-1:r+1,e(r),(!n&&i&&r===i||n&&0===r)&&clearInterval(h)},t))}function s(o){var d,o,h;f="object"==typeof o?o:f.concat(o.split("|")),a(function(r){switch(h=f.shift(),d=i(h),o=t(h),d){case"countdown":o=parseInt(o)||10,o=o>0?o:10,a(function(e){0===e?0===f.length?n.Shape.switchShape(n.ShapeBuilder.letter("")):s(f):n.Shape.switchShape(n.ShapeBuilder.letter(e),!0)},1e3,o,!0);break;case"rectangle":o=o&&o.split("x"),o=o&&2===o.length?o:[u,u/2],n.Shape.switchShape(n.ShapeBuilder.rectangle(Math.min(u,parseInt(o[0])),Math.min(u,parseInt(o[1]))));break;case"circle":o=parseInt(o)||u,o=Math.min(o,u),n.Shape.switchShape(n.ShapeBuilder.circle(o));break;case"time":var c=e(new Date);f.length>0?n.Shape.switchShape(n.ShapeBuilder.letter(c)):a(function(){c=e(new Date),c!==l&&(l=c,n.Shape.switchShape(n.ShapeBuilder.letter(l)))},1e3);break;default:"."==h[0]?n.ShapeBuilder.imageFile(h,n.Shape.switchShape):n.Shape.switchShape(n.ShapeBuilder.letter(h))}},3e3,f.length)}function o(){}function d(){o(),c&&document.body.classList.add("touch")}var h,r,l,c=(document.querySelector(".ui-input"),document.querySelector(".ui"),document.querySelector(".help"),document.querySelector(".commands"),document.querySelector(".overlay"),document.querySelector(".canvas"),!1),u=30,f=[],m="#";return d(),{simulate:function(e){s(e)}}}(),n.Point=function(e){this.x=e.x,this.y=e.y,this.z=e.z,this.a=e.a,this.h=e.h},n.Color=function(e,t,i,n){this.r=e,this.g=t,this.b=i,this.a=n},n.Color.prototype={render:function(){return"rgba("+this.r+","+ +this.g+","+this.b+","+this.a+")"}},n.Dot=function(e,t){this.p=new n.Point({x:e,y:t,z:5,a:1,h:0}),this.e=.07,this.s=!0,this.c=new n.Color(255,255,255,this.p.a),this.t=this.clone(),this.q=[]},n.Dot.prototype={clone:function(){return new n.Point({x:this.x,y:this.y,z:this.z,a:this.a,h:this.h})},_draw:function(){this.c.a=this.p.a,n.Drawing.drawCircle(this.p,this.c)},_moveTowards:function(e){var t=this.distanceTo(e,!0),i=t[0],n=t[1],a=t[2],s=this.e*a;if(-1===this.p.h)return this.p.x=e.x,this.p.y=e.y,!0;if(a>1)this.p.x-=i/a*s,this.p.y-=n/a*s;else{if(!(this.p.h>0))return!0;this.p.h--}return!1},_update:function(){if(this._moveTowards(this.t)){var e=this.q.shift();e?(this.t.x=e.x||this.p.x,this.t.y=e.y||this.p.y,this.t.z=e.z||this.p.z,this.t.a=e.a||this.p.a,this.p.h=e.h||0):this.s?(this.p.x-=Math.sin(3.142*Math.random()),this.p.y-=Math.sin(3.142*Math.random())):this.move(new n.Point({x:this.p.x+50*Math.random()-25,y:this.p.y+50*Math.random()-25}))}d=this.p.a-this.t.a,this.p.a=Math.max(.1,this.p.a-.05*d),d=this.p.z-this.t.z,this.p.z=2},distanceTo:function(e,t){var i=this.p.x-e.x,n=this.p.y-e.y,a=Math.sqrt(i*i+n*n);return t?[i,n,a]:a},move:function(e,t){(!t||t&&this.distanceTo(e)>1)&&this.q.push(e)},render:function(){this._update(),this._draw()}},n.ShapeBuilder=function(){function e(){d.width=Math.floor(window.innerWidth/o)*o,d.height=Math.floor(window.innerHeight/o)*o,r.fillStyle="red",r.textBaseline="middle",r.textAlign="center"}function t(){var e=r.getImageData(0,0,d.width,d.height).data;dots=[],x=0,y=0,fx=d.width,fy=d.height,w=0,h=0;for(var t=0;t<e.length;t+=4*o)e[t+3]>0&&(dots.push(new n.Point({x:x,y:y})),w=x>w?x:w,h=y>h?y:h,fx=x<fx?x:fx,fy=y<fy?y:fy),x+=o,x>=d.width&&(x=0,y+=o,t+=4*o*d.width);return{dots:dots,w:w+fx,h:h+fy}}function i(e){r.font="bold "+e+"px "+c}function a(e){return!isNaN(parseFloat(e))&&isFinite(e)}function s(){e(),window.addEventListener("resize",e)}var o=5,d=document.createElement("canvas"),r=d.getContext("2d"),l=500,c="Avenir, Helvetica Neue, Helvetica, Arial, sans-serif";return s(),{imageFile:function(e,i){var a=new Image,s=n.Drawing.getArea();a.onload=function(){r.clearRect(0,0,d.width,d.height),r.drawImage(this,0,0,.4*s.w,1.375*s.w),i(t())},a.onerror=function(){i(n.ShapeBuilder.letter("What?"))},a.src=e},circle:function(e){var i=Math.max(0,e)/2;return r.clearRect(0,0,d.width,d.height),r.beginPath(),r.arc(i*o,i*o,i*o,0,2*Math.PI,!1),r.fill(),r.closePath(),t()},letter:function(e){var n=0;return i(l),n=Math.min(l,d.width/r.measureText(e).width*.8*l,d.height/l*(a(e)?1:.45)*l),i(n),r.clearRect(0,0,d.width,d.height),r.fillText(e,d.width/2,d.height/2),t()},rectangle:function(e,t){for(var i=[],a=o*e,s=o*t,d=0;s>d;d+=o)for(var h=0;a>h;h+=o)i.push(new n.Point({x:h,y:d}));return{dots:i,w:a,h:s}}}}(),n.Shape=function(){function e(){var e=n.Drawing.getArea();s=e.w/2-i/2,o=e.h/2-a/2}var t=[],i=0,a=0,s=0,o=0;return{shuffleIdle:function(){for(var e=n.Drawing.getArea(),i=0;i<t.length;i++)t[i].s||t[i].move({x:Math.random()*e.w,y:Math.random()*e.h})},switchShape:function(d,h){var r,l=n.Drawing.getArea();if(i=d.w,a=d.h,e(),d.dots.length>t.length){r=d.dots.length-t.length;for(var c=1;r>=c;c++)t.push(new n.Dot(l.w/2,l.h/2))}for(var c=0,u=0;d.dots.length>0;)u=Math.floor(Math.random()*d.dots.length),t[c].e=h?.25:t[c].s?.14:.11,t[c].s?t[c].move(new n.Point({z:20*Math.random()+10,a:Math.random(),h:18})):t[c].move(new n.Point({z:5*Math.random()+5,h:h?18:30})),t[c].s=!0,t[c].move(new n.Point({x:d.dots[u].x+s,y:d.dots[u].y+o,a:1,z:5,h:0})),d.dots=d.dots.slice(0,u).concat(d.dots.slice(u+1)),c++;for(var u=c;u<t.length;u++)t[u].s&&(t[u].move(new n.Point({z:20*Math.random()+10,a:Math.random(),h:20})),t[u].s=!1,t[u].e=.04,t[u].move(new n.Point({x:Math.random()*l.w,y:Math.random()*l.h,a:.3,z:4*Math.random(),h:0})))},render:function(){for(var e=0;e<t.length;e++)t[e].render()}}}()}();var o={slideFlag:!1,slideIndex:1,init:function(){this.loading(),this.bindTouchEvents(),this.bindPhotoEvents()},loading:function(){function e(){s=100,n.text(s+"%"),n.addClass("fadeOut"),setTimeout(function(){n.text("故事即将开始"),n.removeClass("fadeOut").addClass("fadeIn page-entry")},1e3),setTimeout(function(){i.addClass("fadeOut"),t.showSlidePage1()},2e3),setTimeout(function(){i.remove()},3e3)}var t=this,i=a(".loading-page"),n=(i.find("img"),i.find(".loading-status")),s=0,o=function(){99>s&&(s++,n.text(s+"%"),setTimeout(o,300))};o(),window.isPageLoaded&&e(),a(window).on("load",e)},bindTouchEvents:function(){var e=this,t=a("#fs-page-list"),i=new s.Manager(t.get(0));i.add(new s.Swipe),i.on("swipeup",function(){e.slideFlag&&e.slideIndex<5&&(e.disableSlide(),e.slideIndex++,t.attr("data-index",""+e.slideIndex),e["showSlidePage"+e.slideIndex]&&e["showSlidePage"+e.slideIndex](),setTimeout(function(){var i=t.find(".page").eq(e.slideIndex-2);i.removeClass("page-active"),i.find(".active").each(function(e,t){var i=t.className;a(t).removeClass().addClass(i.replace("In","Out")).removeClass("active")})},1e3))}),i.on("swipedown",function(){e.slideFlag&&e.slideIndex>1&&(e.disableSlide(),e.slideIndex--,t.attr("data-index",""+e.slideIndex),e["showSlidePage"+e.slideIndex]&&e["showSlidePage"+e.slideIndex](),setTimeout(function(){var i=t.find(".page").eq(e.slideIndex);i.removeClass("page-active"),i.find(".active").each(function(e,t){var i=t.className;a(t).removeClass().addClass(i.replace("In","Out")).removeClass("active")})},1e3))})},bindPhotoEvents:function(){var e=this,t=a(".photo-page"),i=t.find("img"),n=t.find(".photo-mask");a("#arrow");i.on("click",function(){var t=a(this);t.hasClass("active")?(t.removeClass("active"),n.removeClass("active"),e.enableSlide()):(t.addClass("active"),n.addClass("active"),e.disableSlide())}),n.on("click",function(){a(this).removeClass("active"),i.removeClass("active"),e.enableSlide()})},enableSlide:function(){this.slideFlag=!0,a("#arrow").addClass("active")},disableSlide:function(){this.slideFlag=!1,a("#arrow").removeClass("active")},showSlidePage1:function(){var e=this,t=a(".slide-page-1"),i=t.find("h1"),n=t.find(".poem"),s=t.find(".us"),o=t.find(".city");t.addClass("page-active"),setTimeout(function(){i.removeClass("bounceOutDown").addClass("active bounceInDown")},1e3),setTimeout(function(){o.removeClass("fadeOut").addClass("active fadeIn")},1e3),setTimeout(function(){s.addClass("active")},2e3),setTimeout(function(){n.removeClass("zoomOut").addClass("active zoomIn")},3e3),setTimeout(function(){e.enableSlide()},4500)},showSlidePage2:function(){var e=this,t=a(".slide-page-2"),i=t.find("h1"),n=t.find(".poem"),s=t.find(".us"),o=t.find(".city1"),d=t.find(".city2");t.addClass("page-active"),setTimeout(function(){i.removeClass("zoomOut").addClass("active zoomIn")},2e3),setTimeout(function(){o.removeClass("slideOutUp").addClass("active slideInUp"),d.removeClass("slideOutDown").addClass("active slideInDown")},1e3),setTimeout(function(){s.addClass("active")},3e3),setTimeout(function(){i.find(".railway img").addClass("moving"),s.find(".yy img").addClass("animated infinite wobble"),s.find(".tt img").addClass("animated infinite pulse"),n.removeClass("zoomOutLeft").addClass("active zoomInLeft")},5e3),setTimeout(function(){e.enableSlide()},6500)},showSlidePage3:function(){var e=this,t=a(".slide-page-3"),n=t.find("h1"),s=t.find(".poem1"),o=t.find(".poem2"),d=t.find(".us"),h=t.find(".xi"),r=t.find(".city");t.addClass("page-active"),setTimeout(function(){s.removeClass("fadeOutRight").addClass("active fadeInRight")},500),setTimeout(function(){o.removeClass("fadeOutLeft").addClass("active fadeInLeft")},1500),setTimeout(function(){r.removeClass("slideOutUp").addClass("active slideInUp")},2500),setTimeout(function(){n.removeClass("flipOutX").addClass("active flipInX")},3500),setTimeout(function(){d.removeClass("flipOutY").addClass("active flipInY")},4500),setTimeout(function(){h.removeClass("fadeOut").addClass("active fadeIn")},5500),setTimeout(function(){i()},5500),setTimeout(function(){e.enableSlide()},8e3)},showSlidePage4:function(){var e=this,t=a(".photo-page");setTimeout(function(){t.addClass("page-active")},1e3),setTimeout(function(){e.enableSlide()},2e3)},showSlidePage5:function(){var e=this;a(".canvas-page");setTimeout(function(){n.init()},1e3),setTimeout(function(){e.slideFlag=!0},2e4)}};t.exports=o});